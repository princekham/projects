- no of threads = 5
  - button 1 interrupt (for starting pump 1)
    - one press to enter change mode - cursor blinks to show the chosen menu - another press to enter change number mode after change press once to exit all or 1 mins time out
  -  LCD display : 0.96 in i2c oled (https://randomnerdtutorials.com/guide-for-oled-display-with-arduino/)
     - pins : A4 - SDA, A5 - SCL, 5V , GND
     - The following codes is working fine.
     
```
#include <Wire.h>
#include <Adafruit_GFX.h>
#include <Adafruit_SSD1306.h>

#define SCREEN_WIDTH 128 // OLED display width, in pixels
#define SCREEN_HEIGHT 64 // OLED display height, in pixels

// Declaration for an SSD1306 display connected to I2C (SDA, SCL pins)
Adafruit_SSD1306 display(SCREEN_WIDTH, SCREEN_HEIGHT, &Wire, -1);

void setup() {
  Serial.begin(115200);

  if(!display.begin(SSD1306_SWITCHCAPVCC, 0x3C)) { // Address 0x3D for 128x64
    Serial.println(F("SSD1306 allocation failed"));
    for(;;);
  }
  delay(2000);
  display.clearDisplay();

  display.setTextSize(1);
  display.setTextColor(WHITE);
  display.setCursor(0, 10);
  // Display static text
  display.println("Hello, world!");
  display.display(); 
}

void loop() {
  
}
```

- This one is with bigger FreeSerif font ; I prefer this font size

```
/*********
  Rui Santos
  Complete project details at https://randomnerdtutorials.com  
*********/

#include <Wire.h>
#include <Adafruit_GFX.h>
#include <Adafruit_SSD1306.h>
#include <Fonts/FreeSerif9pt7b.h>

#define SCREEN_WIDTH 128 // OLED display width, in pixels
#define SCREEN_HEIGHT 64 // OLED display height, in pixels

// Declaration for an SSD1306 display connected to I2C (SDA, SCL pins)
Adafruit_SSD1306 display(SCREEN_WIDTH, SCREEN_HEIGHT, &Wire, -1);

void setup() {
  Serial.begin(115200);

  if(!display.begin(SSD1306_SWITCHCAPVCC, 0x3C)) { 
    Serial.println("SSD1306 allocation failed");
    for(;;);
  }
  delay(2000);

  display.setFont(&FreeSerif9pt7b);
  display.clearDisplay();
  display.setTextSize(1);             
  display.setTextColor(WHITE);        
  display.setCursor(0,20);             
  display.println("Hello, world!");
  display.display();
  delay(2000); 
}
void loop() {
  
}
```


- I am going to use two lines with font size 2;The cursor position for the two lines will be (0,30) and (0,60); for the > and X, I need to indent 25 space like (25,30) and (25,60)
  -  rotary encoder
     - pin encoder pin 1 - 2, encoder pin 2 - 3, push button - 4 (https://www.instructables.com/Improved-Arduino-Rotary-Encoder-Reading/)
     - Codes from the above web link is working well. 
     - Please be noted that the GND pin for my rotary encoder is the middle pin
     - for no interrupt you can use the codes from encoder.h (https://www.seeedstudio.com/blog/2020/01/19/rotary-encoders-how-it-works-how-to-use-with-arduino/)
     - I still need to look at https://www.instructables.com/Easy-Arduino-Menus-for-Rotary-Encoders/ 
     - for ecoder with menu; That's not so useful
     - This one would be helpful - https://curiousscientist.tech/blog/20x4lcd-rotaryencoder-menu
     - I need to modify the codes from that; it is as follow:
 ```
 //20x4 LCD
//#include <LiquidCrystal_I2C.h> //SDA = B7[A4], SCL = B6[A5] STM32/[Arduino]
//LiquidCrystal_I2C lcd(0x27, 20, 4);

#include <Wire.h>
#include <Adafruit_GFX.h>
#include <Adafruit_SSD1306.h>

#define SCREEN_WIDTH 128 // OLED display width, in pixels
#define SCREEN_HEIGHT 64 // OLED display height, in pixels

// Declaration for an SSD1306 display connected to I2C (SDA, SCL pins)
Adafruit_SSD1306 display(SCREEN_WIDTH, SCREEN_HEIGHT, &Wire, -1);
//The above OLED sections are added by Sao

int menuCounter = 0; //counts the clicks of the rotary encoder between menu items (0-3 in this case)

int menu1_Value = 0; //value within menu 1
int menu2_Value = 0; //value within menu 2
//int menu3_Value = 0; //value within menu 3
//int menu4_Value = 0; //value within menu 4

bool menu1_selected = false; //enable/disable to change the value of menu item
bool menu2_selected = false;
//bool menu3_selected = false;
//bool menu4_selected = false;
//Note: if a menu is selected ">" becomes "X".

//Defining pins
//Arduino interrupt pins: 2, 3.
//const int RotaryCLK = PB3; //CLK pin on the rotary encoder
//const int RotaryDT = PB4; //DT pin on the rotary encoder
//const int PushButton = PB5; //Button to enter/exit menu

const int RotaryCLK = 2; //CLK pin on the rotary encoder
const int RotaryDT =3; //DT pin on the rotary encoder
const int PushButton = 4; //Button to enter/exit menu

//Statuses for the rotary encoder
int CLKNow;
int CLKPrevious;

int DTNow;
int DTPrevious;

bool refreshLCD = true; //refreshes values
bool refreshSelection = false; //refreshes selection (> / X)

void setup() 
{
  pinMode(2, INPUT_PULLUP); //RotaryCLK
  pinMode(3, INPUT_PULLUP); //RotaryDT
  pinMode(4, INPUT_PULLUP); //Button

  //------------------------------------------------------
 // lcd.begin();                      // initialize the lcd   
 // lcd.backlight();
  //------------------------------------------------------
  //.................This part added by Sao
    if(!display.begin(SSD1306_SWITCHCAPVCC, 0x3C)) { 
    Serial.println("SSD1306 allocation failed");
    for(;;);
  }
  delay(2000);

  display.setFont(&FreeSerif9pt7b);
  display.clearDisplay();
  display.setTextSize(1);             
  display.setTextColor(WHITE);        
  display.setCursor(0,10);  
  
  display.println("Menu demo");
  display.display();
  delay(2000); 
  display.clearDisplay();
  //................................................
  
  // lcd.setCursor(0,0); //Defining positon to write from first row, first column .
  //lcd.print("Menu demo");
 // lcd.setCursor(0,1); //Second row, first column
 // lcd.print("Rotary encoder"); 
 // lcd.setCursor(0,2); //Second row, first column
//  lcd.print("Improved version"); 
//  delay(5000); //wait 2 sec
  
//  lcd.clear(); //clear the whole LCD
  
  printLCD(); //print the stationary parts on the screen
  //------------------------------------------------------
  //Store states of the rotary encoder
  CLKPrevious = digitalRead(RotaryCLK);
  DTPrevious = digitalRead(RotaryDT);
      
  attachInterrupt(digitalPinToInterrupt(RotaryCLK), rotate, CHANGE); //CLK pin is an interrupt pin
  attachInterrupt(digitalPinToInterrupt(PushButton), pushButton, FALLING); //PushButton pin is an interrupt pin

}

void loop() 
{
  if(refreshLCD == true) //If we are allowed to update the LCD ...
  {
   // updateLCD(); // ... we update the LCD ...
    display.display(); //Added by Sao

    //... also, if one of the menus are already selected...
    if(menu1_selected == true || menu2_selected == true || menu3_selected == true || menu4_selected == true)
    {
     // do nothing
    }
    else
    {
      updateCursorPosition(); //update the position
    }
    
    refreshLCD = false; //reset the variable - wait for a new trigger
  }

  if(refreshSelection == true) //if the selection is changed
  {
    updateSelection(); //update the selection on the LCD
    refreshSelection = false; // reset the variable - wait for a new trigger
  }
}

void rotate()
{  
  //-----MENU1--------------------------------------------------------------
  if(menu1_selected == true)
  {
  CLKNow = digitalRead(RotaryCLK); //Read the state of the CLK pin
  // If last and current state of CLK are different, then a pulse occurred  
  if (CLKNow != CLKPrevious  && CLKNow == 1)
  {
    // If the DT state is different than the CLK state then
    // the encoder is rotating in A direction, so we increase
    if (digitalRead(RotaryDT) != CLKNow) 
    {
      if(menu1_Value < 100) //we do not go above 100
      {
        menu1_Value++;  
      }
      else
      {
        menu1_Value = 0;  
      }      
    } 
    else 
    {
      if(menu1_Value < 1) //we do not go below 0
      {
          menu1_Value = 100;
      }
      else
      {
      // Encoder is rotating B direction so decrease
      menu1_Value--;      
      }      
    }    
  }
  CLKPrevious = CLKNow;  // Store last CLK state
  }
  //---MENU2---------------------------------------------------------------
  else if(menu2_selected == true)
  {
    CLKNow = digitalRead(RotaryCLK); //Read the state of the CLK pin
  // If last and current state of CLK are different, then a pulse occurred  
  if (CLKNow != CLKPrevious  && CLKNow == 1)
  {
    // If the DT state is different than the CLK state then
    // the encoder is rotating in A direction, so we increase
    if (digitalRead(RotaryDT) != CLKNow) 
    {
      if(menu2_Value < 100) //we do not go above 100
      {
        menu2_Value++;  
      }
      else
      {
        menu2_Value = 0;  
      }      
    } 
    else 
    {
      if(menu2_Value < 1) //we do not go below 0
      {
          menu2_Value = 100;
      }
      else
      {
      // Encoder is rotating in B direction, so decrease
      menu2_Value--;      
      }      
    }    
  }
  CLKPrevious = CLKNow;  // Store last CLK state
  }
  
  else //MENU COUNTER----------------------------------------------------------------------------
  {
  CLKNow = digitalRead(RotaryCLK); //Read the state of the CLK pin
  // If last and current state of CLK are different, then a pulse occurred  
  if (CLKNow != CLKPrevious  && CLKNow == 1)
  {
    // If the DT state is different than the CLK state then
    // the encoder is rotating in A direction, so we increase
    if (digitalRead(RotaryDT) != CLKNow) 
    {
      if(menuCounter < 3) //we do not go above 3
      {
        menuCounter++;  
      }
      else
      {
        menuCounter = 0;  
      }      
    } 
    else 
    {
      if(menuCounter < 1) //we do not go below 0
      {
          menuCounter = 3;
      }
      else
      {
      // Encoder is rotating CW so decrease
      menuCounter--;      
      }      
    }    
  }
  CLKPrevious = CLKNow;  // Store last CLK state
  }

  //Refresh LCD after changing the counter's value
  refreshLCD = true;
}

void pushButton()
{
  switch(menuCounter)
  {
     case 0:
     menu1_selected = !menu1_selected;  //we change the status of the variable to the opposite
     break;

     case 1:
     menu2_selected = !menu2_selected;
     break;

  } 
  
  refreshLCD = true; //Refresh LCD after changing the value of the menu
  refreshSelection = true; //refresh the selection ("X")
}

void printLCD()
{
  //These are the values which are not changing the operation
  
 // lcd.setCursor(1,0); //1st line, 2nd block
 // lcd.print("Menu 1"); //text
  //----------------------
//  lcd.setCursor(1,1); //2nd line, 2nd block
//  lcd.print("Menu 2"); //text
  //----------------------
//  lcd.setCursor(13,0); //1st line, 14th block
//  lcd.print("cnt: "); //counts - text 
  
  display.setCursor(0, 10);
  display.println ("Menu 1"); //text
  display.display();
  
  display.setCursor(1, 10);
  display.println ("Menu 2"); //text
  display.display();
  
  display.setCursor(1, 23);
  display.println ("cnt: "); //text
  display.display();
  
 }

void updateLCD()
{  
  //lcd.setCursor(17,0); //1st line, 18th block
  //lcd.print(menuCounter); //counter (0 to 3)
  
  display.setCursor(1, 27);
  display.println (menuCounter); //counter 0 to 1
  display.display();
  

 // lcd.setCursor(9,0); //1st line, 10th block
//  lcd.print("   "); //erase the content by printing space over it
 // lcd.setCursor(9,0); //1st line, 10th block
//  lcd.print(menu1_Value); //print the value of menu1_Value variable

  display.setCursor(0, 19);
  display.println ("   "); //text
  display.setCursor(0, 19);
  display.println (menu1_Value);
  display.display();
  
 // lcd.setCursor(9,1);
//  lcd.print("   ");
//  lcd.setCursor(9,1);
//  lcd.print(menu2_Value); //
  
  display.setCursor(1, 19);
  display.println ("   "); //text
  display.setCursor(1, 19);
  display.println (menu2Value);
  display.display();
  
}
// last finished here by Sao

void updateCursorPosition()
{
  //Clear display's ">" parts 
//  lcd.setCursor(0,0); //1st line, 1st block
//  lcd.print(" "); //erase by printing a space
//  lcd.setCursor(0,1);
//  lcd.print(" "); 
display.setCursor(0, 0);
display.println (" ");
display.setCursor(1, 0);
display.println (" ");
display.display();
     
  //Place cursor to the new position
  switch(menuCounter) //this checks the value of the counter (0, 1, 2 or 3)
  {
    case 0:
//  lcd.setCursor(0,0); //1st line, 1st block
 // lcd.print(">"); 
    display.setCursor(0, 0)
    display.println (">");
    break;
    //-------------------------------
    case 1:
  //  lcd.setCursor(0,1); //2nd line, 1st block
  // lcd.print(">"); 
    display.setCursor(1, 0);
    display.println (">");
    break;
    //-------------------------------    

  }
}

void updateSelection()
{
  //When a menu is selected ">" becomes "X"

  if(menu1_selected == true)
  {
  //  lcd.setCursor(0,0); //1st line, 1st block
  //  lcd.print("X"); 
    display.setCursor(0, 0)
    display.println ("X");
  }
  //-------------------
   if(menu2_selected == true)
  {
 //   lcd.setCursor(0,1); //2nd line, 1st block
 //   lcd.print("X"); 
    display.setCursor(1, 0);
    display.println ("X");
  }
  //-------------------

}
```



- microcontroller to use - arduino Uno (2,3) https://www.arduino.cc/reference/en/language/functions/external-interrupts/attachinterrupt/
- will use FreeRTOS
- 
- 
